#!/bin/sh

# Reads the list of files as generated by gen-miscoded-files-list on stdin and
# applies fixes to the issues listed. For use building the server's Docker
# container

set -euo pipefail

while IFS=": " read file issue; do
    case $issue in
        utf8-bom )
            echo "Fixing needless BOM on $file"
            LC_ALL=C LANG=C sed -i '1s/^\xEF\xBB\xBF//' "$file"
            ;;
        cp1252 )
            echo "Converting from CP-1252 to UTF-8 for $file"
            iconv -f cp1252 -t utf-8 "$file" > /tmp/tmp.out
            mv /tmp/tmp.out "$file"
            ;;
        * )
            echo "Unable to fix $file!"
            exit 1
            ;;
    esac
done
